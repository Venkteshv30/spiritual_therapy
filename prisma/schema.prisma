generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  user
  guru
  admin
  helpdesk
}

enum MembershipTier {
  free
  silver
  gold
  premium
}

enum SessionInitiatedType {
  nakshatra
  profession
  manual
  open
  random
}

enum SessionStatus {
  pending
  approved
  rejected
}

model Users {
  id            BigInt    @id @default(autoincrement())
  firebase_uid  String    @unique
  first_name    String
  last_name     String
  email         String    @unique
  phone         String    @unique
  dob           DateTime?
  nakshatra_id  Int?
  profession_id Int?
  address       String?
  role          Role      @default(user)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  nakshatra          Nakshatras?        @relation(fields: [nakshatra_id], references: [id])
  profession         Professions?       @relation(fields: [profession_id], references: [id])
  memberships        UserMemberships[]
  sessions_requested Sessions[]         @relation("RequestedSessions")
  sessions_owned     Sessions[]         @relation("GuruSessions")
  meetings_owned     Meetings[]
  attendees          MeetingAttendees[]

  @@map("users")
}

model Nakshatras {
  id    Int     @id @default(autoincrement())
  name  String
  users Users[]

  @@map("nakshatras")
}

model Professions {
  id    Int     @id @default(autoincrement())
  title String
  users Users[]

  @@map("professions")
}

model Memberships {
  id           Int               @id @default(autoincrement())
  tier         MembershipTier
  price        Float
  max_sessions Int
  created_at   DateTime          @default(now())
  users        UserMemberships[]

  @@map("memberships")
}

model UserMemberships {
  id            BigInt   @id @default(autoincrement())
  user_id       BigInt
  membership_id Int
  start_date    DateTime
  end_date      DateTime
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now())

  user       Users       @relation(fields: [user_id], references: [id])
  membership Memberships @relation(fields: [membership_id], references: [id])

  @@map("user_memberships")
}

model Sessions {
  id             BigInt               @id @default(autoincrement())
  title          String
  description    String?
  initiated_type SessionInitiatedType
  criteria_value String?
  requested_by   BigInt?
  guru_id        BigInt
  status         SessionStatus        @default(pending)
  created_at     DateTime             @default(now())

  requester Users?     @relation("RequestedSessions", fields: [requested_by], references: [id])
  guru      Users      @relation("GuruSessions", fields: [guru_id], references: [id])
  meetings  Meetings[]

  @@map("sessions")
}

model Meetings {
  id               BigInt    @id @default(autoincrement())
  session_id       BigInt
  guru_id          BigInt
  title            String
  start_time       DateTime
  end_time         DateTime?
  max_attendees    Int
  agora_channel_id String
  agora_token      String
  is_live          Boolean   @default(false)
  created_at       DateTime  @default(now())

  session   Sessions           @relation(fields: [session_id], references: [id])
  guru      Users              @relation(fields: [guru_id], references: [id])
  attendees MeetingAttendees[]

  @@map("meetings")
}

model MeetingAttendees {
  id         BigInt    @id @default(autoincrement())
  meeting_id BigInt
  user_id    BigInt
  joined_at  DateTime  @default(now())
  left_at    DateTime?
  auto_added Boolean   @default(false)

  meeting Meetings @relation(fields: [meeting_id], references: [id])
  user    Users    @relation(fields: [user_id], references: [id])

  @@map("meeting_attendees")
}
